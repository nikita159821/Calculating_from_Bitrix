<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Расчет данных из Bitrix</title>
  <style>
    body {
      font-family: sans-serif;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid black;
      padding: 8px;
    }
    th {
      background-color: green;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    #result {
      margin-top: 20px;
      max-height: 500px; /* Установите желаемую максимальную высоту /
      overflow-y: auto; / Добавляем вертикальный скролл */
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 30%;
    }
  </style>
</head>
<body>
  <h1>Расчет данных из Bitrix</h1>
  <input type="file" id="excelFile" accept=".xls,.xlsx">
  <button onclick="processExcelFile()">Загрузить</button>
  <button onclick="downloadExcelFile()">Скачать</button>
  <div id="result">
    <!-- Таблица будет добавлена здесь -->
  </div>

  <div id="errorModal" class="modal">
    <div class="modal-content">
      <h2>Ошибка</h2>
      <p>Неподдерживаемый формат файла</p>
      <button onclick="closeErrorModal()">Закрыть</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
  <script>
    let processedData = null; // Сохранение обработанных данных

    const getPurchaseCoeff = (purchases) => {
      if (isNaN(purchases) || purchases <= 0) {
        return 0;
      }
      return 0.03 * purchases;
    };

    const getViewCoeff = (views) => {
      if (isNaN(views) || views <= 0) {
        return 0;
      }
      return 0.0000125 * views;
    };

    const getStockCoeff = (purchases) => {
      if (isNaN(purchases) || purchases <= 0) {
        return 0;
      }
      return 0.0015 * purchases;
    };

    function processExcelFile() {
  const file = document.getElementById('excelFile').files[0];
  if (!file) {
    showErrorModal();
    return;
  }

  const fileName = file.name.toLowerCase();
  if (!fileName.endsWith('.xls') && !fileName.endsWith('.xlsx')) {
    showErrorModal();
    return;
  }

  const reader = new FileReader();

  reader.onload = (event) => {
    const data = event.target.result;

    try {
      // Использование библиотеки XLSX для работы с Excel
      const workbook = XLSX.read(data, { type: 'binary' });
      const sheetName = workbook.SheetNames[0]; // Используем первый лист
      const worksheet = workbook.Sheets[sheetName];
      const excelData = XLSX.utils.sheet_to_json(worksheet);

      // Обработка данных, аналогично Python-коду
      const df = excelData.map((row, index) => {
        const viewCount = parseFloat(row['Количество покупок ( не трогать )']),
          purchaseCount = parseFloat(row['Количество просмотров ( не трогать )']),
          stockCount = parseFloat(row['Кол-во в МСК']);
        const productName = row['Название товара'] || '',
          category = (row['Категория'] || '').trim() || 'Без категории';
        const id = row['ID'] || index + 1;

        return {
          'ID': id,
          'Название товара': productName,
          'Категория': category,
          'Количество покупок ( не трогать )': isNaN(viewCount) ? 0 : viewCount,
          'Количество просмотров ( не трогать )': isNaN(purchaseCount) ? 0 : purchaseCount,
          'Кол-во в МСК': isNaN(stockCount) ? 0 : stockCount,
          'Популярность': getPurchaseCoeff(viewCount) + getViewCoeff(purchaseCount),
          'Запас МСК': getStockCoeff(viewCount),
          'ИТОГ': getPurchaseCoeff(viewCount) + getViewCoeff(purchaseCount) + getStockCoeff(viewCount),
          'Порядковый номер': 0,
        };
      });

      // Сортировка по убыванию "ИТОГ"
      df.sort((a, b) => {
        if (a.Категория.includes('Конфигурации') && !b.Категория.includes('Конфигурации')) {
          return 1; // Если a содержит "Конфигурации", а b - нет, то b будет выше в списке
        } else if (!a.Категория.includes('Конфигурации') && b.Категория.includes('Конфигурации')) {
          return -1; // Если b содержит "Конфигурации", а a - нет, то a будет выше в списке
        } else {
          return b.ИТОГ - a.ИТОГ; // Сортировка по убыванию "ИТОГ"
        }
      });

      // Установка значения "Порядковый номер" в порядке убывания
      df.forEach((row, index) => {
        row['Порядковый номер'] = df.length - index;
      });

      // Отображение результата
      displayTable(df);

      // Сохранение обработанных данных
      processedData = df;
    } catch (error) {
      console.error('Error processing Excel file:', error);
      showErrorModal();
    }
  };

  reader.readAsBinaryString(file);
}


    function displayTable(data) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      // Создание шапки таблицы
      const headers = Object.keys(data[0]);
      const headerRow = document.createElement('tr');
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Заполнение тела таблицы
      data.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
          const td = document.createElement('td');
          td.textContent = row[header];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      resultDiv.appendChild(table);
    }

    function downloadExcelFile() {
      if (!processedData) {
        console.error('No data to download');
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(processedData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
      XLSX.writeFile(workbook, 'result.xlsx');
    }

    function showErrorModal() {
      const errorModal = document.getElementById('errorModal');
      errorModal.style.display = 'block';
    }

    function closeErrorModal() {
      const errorModal = document.getElementById('errorModal');
      errorModal.style.display = 'none';
    }
  </script>
</body>
</html>